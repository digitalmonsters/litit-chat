module.exports=[48661,a=>{"use strict";a.i(69387);var b=a.i(60574),c=a.i(18740);let d="ghl_tokens";async function e(a){let e=(0,c.getFirestoreInstance)(),f=(0,b.doc)(e,d,a),g=await (0,b.getDoc)(f);return g.exists()?g.data():null}async function f(a){let f=await e(a);if(!f)throw Error(`No tokens found for location: ${a}`);let g=process.env.GHL_CLIENT_ID,h=process.env.GHL_CLIENT_SECRET;if(!g||!h)throw Error("GHL_CLIENT_ID and GHL_CLIENT_SECRET must be set for token refresh");let i=await fetch("https://services.leadconnectorhq.com/oauth/token",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({grant_type:"refresh_token",client_id:g,client_secret:h,refresh_token:f.refresh_token})});if(!i.ok){let a=await i.json().catch(()=>({message:"Unknown error"}));throw Error(`Token refresh failed: ${a.message||i.statusText}`)}let j=await i.json(),k=Date.now()+1e3*j.expires_in,l={...f,access_token:j.access_token,refresh_token:j.refresh_token||f.refresh_token,expires_in:j.expires_in,expires_at:k,updatedAt:(0,b.serverTimestamp)()},m=(0,c.getFirestoreInstance)(),n=(0,b.doc)(m,d,a);return await (0,b.setDoc)(n,l),console.log(`âœ… Refreshed GHL tokens for location: ${a}`),l}async function g(a){var b;let c=await e(a);if(!c)throw Error(`No tokens found for location: ${a}. Please complete OAuth flow.`);return b=c,Date.now()>=b.expires_at-3e5&&(console.log(`ðŸ”„ Token expired for location ${a}, refreshing...`),c=await f(a)),c.access_token}async function h(a,b={},c={}){let d,{locationId:e,useOAuth:f=!0}=c,i=e||process.env.GHL_LOCATION_ID;if(i&&f)try{let a=await g(i);d=`Bearer ${a}`}catch(b){console.warn("Failed to get OAuth token, falling back to API key:",b);let a=process.env.GHL_API_KEY;if(!a)throw Error("No OAuth token available and GHL_API_KEY not set");d=`Bearer ${a}`}else{let a=process.env.GHL_API_KEY;if(!a)throw Error("GHL_API_KEY environment variable is not set. Please configure it in .env.local");d=`Bearer ${a}`}let j=`https://services.leadconnectorhq.com/v1${a}`,k=await fetch(j,{...b,headers:{Authorization:d,"Content-Type":"application/json",Version:"2021-07-28",...b.headers}});if(!k.ok){let a=await k.json().catch(()=>({message:k.statusText}));throw Error(`GHL API Error: ${k.status} ${k.statusText} - ${JSON.stringify(a)}`)}return k.json()}function i(a){let b=a?.ghlLocationId||process.env.GHL_LOCATION_ID;if(!b)throw Error("GHL_LOCATION_ID is required. Set it in .env.local or user.ghlLocationId");return b}function j(a,b){let c=(a.displayName||"User").trim().split(" "),d=c[0]||"",e=c.slice(1).join(" ")||"",f="",g="",h="";a.location&&("string"==typeof a.location?f=a.location:(f=a.location.address||"",g=a.location.city||"",h=a.location.country||""));let i={firstName:d,lastName:e,email:a.email,phone:a.metadata?.phone,address1:f,city:g,country:h,locationId:b,customField:[{key:"firebaseUid",value:a.id}]};return a.interests&&a.interests.length>0&&i.customField?.push({key:"interests",value:a.interests.join(",")}),i}async function k(a,b){let c="/contacts";if(a.id)try{let d=await h(`${c}/${a.id}`,{method:"PATCH",body:JSON.stringify(a)},{locationId:b,useOAuth:!0});return{id:d.contact?.id||a.id}}catch(e){console.warn(`Failed to update contact ${a.id}, trying to create:`,e);let{id:c,...d}=a;return k(d,b)}let d=await h(c,{method:"POST",body:JSON.stringify(a)},{locationId:b,useOAuth:!0}),e=d.contact?.id;if(!e)throw Error("GHL API did not return contact ID");return{id:e}}async function l(a,b){return null}async function m(a){try{let d=(0,c.getFirestoreInstance)(),e=(0,b.doc)(d,c.COLLECTIONS.USERS,a),f=await (0,b.getDoc)(e);if(!f.exists())return{success:!1,error:`Firebase user ${a} not found`};let g={id:a,...f.data()},h=i(g),m=g.ghlId||g.ghlContactId||void 0;m||(m=await l(a,h)||void 0);let n=j(g,h);m&&(n.id=m);let o=(await k(n,h)).id;return await (0,b.updateDoc)(e,{ghlId:o,ghlContactId:o,ghlLocationId:h,updatedAt:(0,b.serverTimestamp)()}),console.log(`âœ… Synced Firebase user ${a} â†” GHL contact ${o}`),{success:!0,ghlContactId:o}}catch(c){let b=c instanceof Error?c.message:"Unknown error";return console.error(`âŒ Failed to sync Firebase user ${a} to GHL:`,b),{success:!1,error:b}}}async function n(a,d){try{let d=(0,c.getFirestoreInstance)(),e=(0,b.doc)(d,c.COLLECTIONS.USERS,a),f=await (0,b.getDoc)(e);if(!f.exists())return void console.warn(`User ${a} not found, skipping GHL update`);let g={id:a,...f.data()},k=g.ghlId||g.ghlContactId;if(!k)return void await m(a);let l=i(g),n=j(g,l);n.id=k,await h(`/contacts/${k}`,{method:"PATCH",body:JSON.stringify(n)},{locationId:l,useOAuth:!0}),console.log(`âœ… Updated GHL contact ${k} for Firebase user ${a}`)}catch(b){console.error(`âŒ Failed to update GHL contact for user ${a}:`,b)}}a.s(["syncUserToGHL",()=>m,"updateGHLContactOnProfileChange",()=>n],48661)}];

//# sourceMappingURL=lib_ghl-sync_ts_db6e1984._.js.map